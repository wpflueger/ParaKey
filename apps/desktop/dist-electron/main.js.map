{"version":3,"sources":["../electron/main.ts","../electron/grpc-client.ts","../electron/constants.ts","../electron/audio.ts","../electron/hotkeys.ts","../electron/history.ts","../electron/clipboard.ts","../electron/settings.ts","../electron/python-finder.ts","../electron/backend.ts"],"sourcesContent":["import { app, BrowserWindow, dialog, ipcMain, Menu, nativeImage, Tray, screen } from \"electron\";\nimport path from \"node:path\";\nimport { createDictationClient, streamAudio } from \"./grpc-client\";\nimport { createAudioStream } from \"./audio\";\nimport { registerHoldHotkey, stopHotkeyListener } from \"./hotkeys\";\nimport { addTranscript, getHistory, getLastTranscript } from \"./history\";\nimport { sanitizeText, setClipboardText, sendPaste } from \"./clipboard\";\nimport { loadSettings, saveSettings } from \"./settings\";\nimport type { AppSettings } from \"./settings\";\nimport { findPython, installBackendDeps, BackendDepsError, PythonNotFoundError } from \"./python-finder\";\nimport { startBackend } from \"./backend\";\nimport {\n  APP_ROOT,\n  ELECTRON_DIR,\n  IS_DEV,\n  PYTHON_CACHE_PATH,\n  RENDERER_DEV_URL,\n  RENDERER_DIST,\n} from \"./constants\";\n\nlet mainWindow: BrowserWindow | null = null;\nlet overlayWindow: BrowserWindow | null = null;\nlet tray: Tray | null = null;\nlet settings = loadSettings();\nlet backendProcess: { kill: () => void } | null = null;\nlet audioController: Awaited<ReturnType<typeof createAudioStream>> | null = null;\nlet dictationStream: ReturnType<typeof streamAudio> | null = null;\nlet dictationActive = false;\n\nconst createMainWindow = () => {\n  mainWindow = new BrowserWindow({\n    width: 420,\n    height: 620,\n    minWidth: 380,\n    minHeight: 520,\n    show: !settings.startMinimized,\n    backgroundColor: \"#f3ede3\",\n    webPreferences: {\n      preload: path.join(APP_ROOT, \"dist-electron\", \"preload.cjs\"),\n      contextIsolation: true,\n      nodeIntegration: false,\n    },\n  });\n\n  if (IS_DEV) {\n    mainWindow.loadURL(RENDERER_DEV_URL);\n    mainWindow.webContents.openDevTools({ mode: \"detach\" });\n  } else {\n    mainWindow.loadFile(path.join(RENDERER_DIST, \"index.html\"));\n  }\n\n  mainWindow.on(\"close\", (event) => {\n    if (tray) {\n      event.preventDefault();\n      mainWindow?.hide();\n    }\n  });\n};\n\nconst createOverlayWindow = () => {\n  overlayWindow = new BrowserWindow({\n    width: 260,\n    height: 50,\n    transparent: true,\n    frame: false,\n    alwaysOnTop: true,\n    show: false,\n    resizable: false,\n    skipTaskbar: true,\n    webPreferences: {\n      preload: path.join(APP_ROOT, \"dist-electron\", \"overlay-preload.cjs\"),\n      contextIsolation: true,\n      nodeIntegration: false,\n    },\n  });\n\n  overlayWindow.setIgnoreMouseEvents(true);\n  overlayWindow.loadFile(path.join(ELECTRON_DIR, \"overlay.html\"));\n};\n\nconst positionOverlay = (mode: AppSettings[\"overlay\"][\"position\"]) => {\n  if (!overlayWindow) {\n    return;\n  }\n  const { xOffset, yOffset } = settings.overlay;\n  const { width, height } = overlayWindow.getBounds();\n  const { width: screenW, height: screenH } = screen.getPrimaryDisplay().workAreaSize;\n  let x = xOffset;\n  let y = yOffset;\n  if (mode.includes(\"right\")) {\n    x = screenW - width - xOffset;\n  }\n  if (mode.includes(\"bottom\")) {\n    y = screenH - height - yOffset;\n  }\n  overlayWindow.setPosition(x, y, false);\n};\n\nconst showOverlay = (text: string, mode: \"listening\" | \"processing\" | \"inserted\" | \"error\") => {\n  if (!settings.overlay.enabled || !overlayWindow) {\n    return;\n  }\n  positionOverlay(settings.overlay.position);\n  overlayWindow.showInactive();\n  overlayWindow.webContents.send(\"overlay:update\", { text, mode });\n  if (mode !== \"listening\" && settings.overlay.autoHideMs > 0) {\n    setTimeout(() => overlayWindow?.hide(), settings.overlay.autoHideMs);\n  }\n};\n\nconst hideOverlay = () => {\n  overlayWindow?.hide();\n};\n\nconst createTray = () => {\n  tray = new Tray(nativeImage.createEmpty());\n  const contextMenu = Menu.buildFromTemplate([\n    {\n      label: \"Show Window\",\n      click: () => mainWindow?.show(),\n    },\n    {\n      label: \"Copy Last Transcript\",\n      click: () => {\n        const last = getLastTranscript();\n        if (last) {\n          setClipboardText(last);\n        }\n      },\n    },\n    { type: \"separator\" },\n    {\n      label: \"Quit\",\n      click: () => app.quit(),\n    },\n  ]);\n  tray.setToolTip(\"KeyMuse - Press Ctrl+Alt to dictate\");\n  tray.setContextMenu(contextMenu);\n  tray.on(\"double-click\", () => mainWindow?.show());\n};\n\nconst ensureBackend = async () => {\n  const updateStatus = (payload: { status: string }) => {\n    mainWindow?.webContents.send(\"install:status\", payload);\n    mainWindow?.webContents.send(\"backend:status\", { ready: false, detail: payload.status });\n    mainWindow?.webContents.send(\"backend:log\", payload.status);\n  };\n\n  try {\n    const python = findPython(APP_ROOT, true);\n    return python;\n  } catch (error) {\n    if (error instanceof BackendDepsError) {\n      dialog.showMessageBox({\n        type: \"info\",\n        title: \"Installing Dependencies\",\n        message:\n          \"Python dependencies are missing. KeyMuse will install the required packages now.\",\n      });\n      updateStatus({ status: \"Missing Python dependencies. Installing...\" });\n      installBackendDeps(error.pythonPath, path.resolve(APP_ROOT, \"..\", \"..\"));\n      return findPython(APP_ROOT, true);\n    }\n    if (error instanceof PythonNotFoundError) {\n      dialog.showErrorBox(\n        \"Python Required\",\n        \"Python 3.11+ is required to run the speech model. Install Python and restart KeyMuse.\",\n      );\n      mainWindow?.webContents.send(\"startup:error\", {\n        message: \"Python 3.11+ not found. Install Python and restart KeyMuse.\",\n      });\n    }\n    throw error;\n  }\n};\n\nconst startBackendProcess = async () => {\n  const python = await ensureBackend();\n\n  const backend = startBackend(python, {\n    host: settings.backend.host,\n    port: settings.backend.port,\n    onOutput: (line) => {\n      mainWindow?.webContents.send(\"backend:log\", line);\n      mainWindow?.webContents.send(\"backend:status\", {\n        ready: false,\n        detail: line,\n      });\n    },\n  });\n  backendProcess = backend;\n\n  const grpc = createDictationClient(settings.backend.host, settings.backend.port);\n  let ready = false;\n  let attempts = 0;\n  while (!ready) {\n    try {\n      const health = await grpc.GetHealth({});\n      mainWindow?.webContents.send(\"backend:status\", { ready: health.ready, detail: health.detail });\n      ready = health.ready;\n      if (!ready) {\n        await new Promise((resolve) => setTimeout(resolve, 500));\n      }\n    } catch {\n      attempts += 1;\n      const message = attempts === 1 ? \"Waiting for backend...\" : `Waiting for backend... (${attempts})`;\n      mainWindow?.webContents.send(\"backend:status\", {\n        ready: false,\n        detail: message,\n      });\n      mainWindow?.webContents.send(\"backend:log\", message);\n      await new Promise((resolve) => setTimeout(resolve, 500));\n    }\n  }\n};\n\nconst startDictation = async () => {\n  if (dictationActive) {\n    return;\n  }\n  dictationActive = true;\n  mainWindow?.webContents.send(\"dictation:state\", { state: \"RECORDING\" });\n  showOverlay(\"Listening...\", \"listening\");\n\n  const grpc = createDictationClient(settings.backend.host, settings.backend.port);\n  const stream = streamAudio(\n    grpc,\n    (event) => {\n      if (event.partial) {\n        showOverlay(event.partial.text || \"Listening...\", \"listening\");\n      }\n      if (event.final) {\n        const sanitized = sanitizeText(event.final.text);\n        addTranscript(sanitized);\n        mainWindow?.webContents.send(\"dictation:final\", { text: sanitized });\n        setClipboardText(sanitized);\n        sendPaste();\n        showOverlay(`Inserted: ${sanitized.slice(0, 30)}`, \"inserted\");\n      }\n      if (event.error) {\n        mainWindow?.webContents.send(\"dictation:state\", { state: \"ERROR\" });\n        showOverlay(event.error.message, \"error\");\n      }\n    },\n    (error) => {\n      mainWindow?.webContents.send(\"dictation:state\", { state: \"ERROR\" });\n      showOverlay(error.message, \"error\");\n    },\n  );\n  dictationStream = stream;\n\n  audioController = await createAudioStream({\n    sampleRateHz: settings.audio.sampleRateHz,\n    channels: settings.audio.channels,\n    frameMs: settings.audio.frameMs,\n    deviceIndex: settings.audio.deviceIndex,\n  });\n\n  audioController.onFrame((frame) => {\n    dictationStream?.write(frame);\n  });\n  audioController.start();\n};\n\nconst stopDictation = async () => {\n  if (!dictationActive) {\n    return;\n  }\n  dictationActive = false;\n  mainWindow?.webContents.send(\"dictation:state\", { state: \"PROCESSING\" });\n  showOverlay(\"Processing...\", \"processing\");\n  audioController?.stop();\n  dictationStream?.write({\n    audio: Buffer.alloc(0),\n    sample_rate_hz: settings.audio.sampleRateHz,\n    channels: settings.audio.channels,\n    sequence: BigInt(0),\n    end_of_stream: true,\n  });\n  dictationStream?.end();\n  dictationStream = null;\n  await new Promise((resolve) => setTimeout(resolve, 200));\n  hideOverlay();\n  mainWindow?.webContents.send(\"dictation:state\", { state: \"IDLE\" });\n};\n\nconst wireIpc = () => {\n  ipcMain.handle(\"settings:get\", () => settings);\n  ipcMain.handle(\"settings:save\", (_event, next: AppSettings) => {\n    settings = next;\n    saveSettings(settings);\n    return true;\n  });\n  ipcMain.handle(\"history:get\", () => getHistory());\n  ipcMain.handle(\"cache:get\", () => PYTHON_CACHE_PATH);\n  ipcMain.handle(\"dictation:start\", () => startDictation());\n  ipcMain.handle(\"dictation:stop\", () => stopDictation());\n  ipcMain.handle(\"window:show\", () => mainWindow?.show());\n  ipcMain.handle(\"window:minimize\", () => mainWindow?.hide());\n};\n\nconst waitForRenderer = (): Promise<void> =>\n  new Promise((resolve) => {\n    if (!mainWindow) {\n      resolve();\n      return;\n    }\n    if (mainWindow.webContents.isLoading()) {\n      mainWindow.webContents.once(\"did-finish-load\", () => resolve());\n    } else {\n      resolve();\n    }\n  });\n\nconst startApp = async () => {\n  createMainWindow();\n  createOverlayWindow();\n  createTray();\n  wireIpc();\n  await waitForRenderer();\n  mainWindow?.webContents.send(\"startup:cache\", { path: PYTHON_CACHE_PATH });\n  mainWindow?.webContents.send(\"backend:status\", { ready: false, detail: \"Initializing...\" });\n  mainWindow?.webContents.send(\"backend:log\", \"Initializing backend...\");\n  await startBackendProcess();\n\n  registerHoldHotkey({\n    onActivate: startDictation,\n    onDeactivate: stopDictation,\n  });\n};\n\napp.whenReady().then(startApp);\n\napp.on(\"window-all-closed\", () => {\n  // Keep the app running in the tray on Windows.\n});\n\napp.on(\"before-quit\", () => {\n  stopHotkeyListener();\n  backendProcess?.kill();\n  tray?.destroy();\n});\n","import { loadPackageDefinition } from \"@grpc/grpc-js\";\nimport { loadSync } from \"@grpc/proto-loader\";\nimport type { ClientWritableStream } from \"@grpc/grpc-js\";\nimport { PROTO_PATH } from \"./constants\";\n\nexport type HealthStatus = {\n  ready: boolean;\n  mode: string;\n  detail: string;\n};\n\nexport type DictationEvent = {\n  partial?: { text: string };\n  final?: { text: string; from_cache: boolean };\n  status?: { mode: string; detail: string };\n  error?: { code: string; message: string };\n};\n\nexport type AudioFrame = {\n  audio: Buffer;\n  sample_rate_hz: number;\n  channels: number;\n  sequence: bigint;\n  end_of_stream: boolean;\n};\n\ntype GrpcDictationClient = {\n  GetHealth: (payload: Record<string, never>, callback: (error: Error | null, response: HealthStatus) => void) => void;\n  StreamAudio: () => ClientWritableStream<AudioFrame>;\n};\n\nexport type DictationClient = {\n  GetHealth: (payload: Record<string, never>) => Promise<HealthStatus>;\n  StreamAudio: () => ClientWritableStream<AudioFrame>;\n};\n\nexport const createDictationClient = (host: string, port: number): DictationClient => {\n  const protoPath = PROTO_PATH;\n  const packageDefinition = loadSync(protoPath, {\n    keepCase: true,\n    longs: String,\n    enums: String,\n    defaults: true,\n    oneofs: true,\n  });\n\n  const grpcPackage = loadPackageDefinition(packageDefinition) as unknown as {\n    keymuse: { dictation: { v1: { DictationService: new (address: string, creds: unknown) => GrpcDictationClient } } };\n  };\n  const service = grpcPackage.keymuse.dictation.v1.DictationService;\n  const client = new service(`${host}:${port}`, createInsecureCredentials());\n\n  return {\n    GetHealth: (payload: Record<string, never>) =>\n      new Promise((resolve, reject) => {\n        client.GetHealth(payload, (error, response) => {\n          if (error) {\n            reject(error);\n            return;\n          }\n          resolve(response);\n        });\n      }),\n    StreamAudio: () => client.StreamAudio(),\n  };\n};\n\nconst createInsecureCredentials = (): unknown => {\n  // eslint-disable-next-line @typescript-eslint/no-require-imports\n  const grpc = require(\"@grpc/grpc-js\") as { credentials: { createInsecure: () => unknown } };\n  return grpc.credentials.createInsecure();\n};\n\nexport const streamAudio = (\n  client: DictationClient,\n  onEvent: (event: DictationEvent) => void,\n  onError: (error: Error) => void,\n): ClientWritableStream<AudioFrame> => {\n  const stream = client.StreamAudio();\n  stream.on(\"data\", (event: DictationEvent) => onEvent(event));\n  stream.on(\"error\", (error: Error) => onError(error));\n  return stream;\n};\n","import path from \"node:path\";\n\nexport const IS_DEV = process.env.NODE_ENV === \"development\";\n\nexport const APP_ROOT = path.resolve(__dirname, \"..\");\n\nexport const REPO_ROOT = path.resolve(APP_ROOT, \"..\", \"..\");\n\nexport const ELECTRON_DIR = path.join(APP_ROOT, \"electron\");\nexport const PYTHON_CACHE_PATH = \"C:\\\\Users\\\\willp\\\\.cache\\\\huggingface\\\\transformers\";\n\nexport const ELECTRON_DIST = path.join(APP_ROOT, \"dist-electron\");\nexport const RENDERER_DIST = path.join(APP_ROOT, \"dist\");\nexport const RENDERER_DEV_URL = \"http://localhost:5173\";\nexport const PROTO_PATH = path.join(REPO_ROOT, \"shared\", \"proto\", \"dictation.proto\");\n","import type { AudioFrame } from \"./grpc-client\";\n\nexport type AudioStreamOptions = {\n  sampleRateHz: number;\n  channels: number;\n  frameMs: number;\n  deviceIndex?: number | null;\n};\n\nexport type AudioStreamController = {\n  start: () => void;\n  stop: () => void;\n  onFrame: (callback: (frame: AudioFrame) => void) => void;\n};\n\nexport const createAudioStream = async (\n  options: AudioStreamOptions,\n): Promise<AudioStreamController> => {\n  const portAudioModule = await import(\"naudiodon\");\n  const portAudio = portAudioModule as unknown as {\n    AudioInput: new (options: {\n      channelCount: number;\n      sampleFormat: number;\n      sampleRate: number;\n      deviceId?: number;\n      closeOnError: boolean;\n    }) => { on: (event: string, handler: (data: Buffer) => void) => void; start: () => void; stop: () => void };\n    SampleFormat16Bit: number;\n  };\n  const frameSamples = Math.round((options.sampleRateHz * options.frameMs) / 1000);\n  const frameBytes = frameSamples * options.channels * 2;\n\n  const input = new portAudio.AudioInput({\n    channelCount: options.channels,\n    sampleFormat: portAudio.SampleFormat16Bit,\n    sampleRate: options.sampleRateHz,\n    deviceId: options.deviceIndex ?? undefined,\n    closeOnError: true,\n  });\n\n  let sequence = BigInt(0);\n  let onFrame: ((frame: AudioFrame) => void) | null = null;\n  let buffer = Buffer.alloc(0);\n\n  input.on(\"data\", (chunk: Buffer) => {\n    buffer = Buffer.concat([buffer, chunk]);\n    while (buffer.length >= frameBytes) {\n      const frame = buffer.subarray(0, frameBytes);\n      buffer = buffer.subarray(frameBytes);\n      if (onFrame) {\n        onFrame({\n          audio: frame,\n          sample_rate_hz: options.sampleRateHz,\n          channels: options.channels,\n          sequence: sequence++,\n          end_of_stream: false,\n        });\n      }\n    }\n  });\n\n  return {\n    start: () => input.start(),\n    stop: () => input.stop(),\n    onFrame: (callback) => {\n      onFrame = callback;\n    },\n  };\n};\n","import { uIOhook } from \"uiohook-napi\";\n\nexport type HotkeyCallbacks = {\n  onActivate: () => void;\n  onDeactivate: () => void;\n};\n\nconst CTRL_KEYS = new Set([29, 3613]);\nconst ALT_KEYS = new Set([56, 3640]);\n\nexport const registerHoldHotkey = ({ onActivate, onDeactivate }: HotkeyCallbacks): void => {\n  let ctrlDown = false;\n  let altDown = false;\n  let active = false;\n\n  const updateState = () => {\n    const shouldBeActive = ctrlDown && altDown;\n    if (shouldBeActive && !active) {\n      active = true;\n      onActivate();\n    } else if (!shouldBeActive && active) {\n      active = false;\n      onDeactivate();\n    }\n  };\n\n  uIOhook.on(\"keydown\", (event) => {\n    if (CTRL_KEYS.has(event.keycode)) {\n      ctrlDown = true;\n    }\n    if (ALT_KEYS.has(event.keycode)) {\n      altDown = true;\n    }\n    updateState();\n  });\n\n  uIOhook.on(\"keyup\", (event) => {\n    if (CTRL_KEYS.has(event.keycode)) {\n      ctrlDown = false;\n    }\n    if (ALT_KEYS.has(event.keycode)) {\n      altDown = false;\n    }\n    updateState();\n  });\n\n  uIOhook.start();\n};\n\nexport const stopHotkeyListener = (): void => {\n  uIOhook.removeAllListeners();\n  uIOhook.stop();\n};\n","const MAX_HISTORY = 10;\nlet history: string[] = [];\n\nexport const addTranscript = (text: string): void => {\n  history = [...history, text].slice(-MAX_HISTORY);\n};\n\nexport const getHistory = (): string[] => [...history];\n\nexport const getLastTranscript = (): string | null => {\n  if (history.length === 0) {\n    return null;\n  }\n  return history[history.length - 1];\n};\n\nexport const clearHistory = (): void => {\n  history = [];\n};\n","import { clipboard } from \"electron\";\n\n// eslint-disable-next-line no-control-regex\nconst CONTROL_PATTERN = /[\\u0000-\\u0008\\u000B\\u000C\\u000E-\\u001F]/g;\nconst BIDI_PATTERN = new RegExp(\"[\\\\u200E\\\\u200F\\\\u202A-\\\\u202E\\\\u2066-\\\\u2069]\", \"g\");\n\nexport const sanitizeText = (text: string): string => {\n  let sanitized = text.replace(CONTROL_PATTERN, \"\").replace(BIDI_PATTERN, \"\");\n  sanitized = sanitized.normalize(\"NFC\");\n  sanitized = sanitized.replace(/\\r\\n/g, \"\\n\").replace(/\\r/g, \"\\n\").replace(/\\n/g, \"\\r\\n\");\n  return sanitized;\n};\n\nexport const setClipboardText = (text: string): void => {\n  clipboard.writeText(text);\n};\n\nexport const getClipboardText = (): string => clipboard.readText();\n\nexport const sendPaste = (): void => {\n  // TODO: Implement native paste simulation.\n};\n","import { app } from \"electron\";\nimport fs from \"node:fs\";\nimport path from \"node:path\";\n\nexport type HotkeySettings = {\n  modifiers: number[];\n  debounceMs: number;\n};\n\nexport type AudioSettings = {\n  deviceIndex: number | null;\n  deviceName: string | null;\n  sampleRateHz: number;\n  channels: number;\n  frameMs: number;\n};\n\nexport type BackendSettings = {\n  host: string;\n  port: number;\n  timeoutSeconds: number;\n  autoReconnect: boolean;\n};\n\nexport type OverlaySettings = {\n  enabled: boolean;\n  position: \"top-left\" | \"top-right\" | \"bottom-left\" | \"bottom-right\";\n  xOffset: number;\n  yOffset: number;\n  autoHideMs: number;\n};\n\nexport type AppSettings = {\n  hotkey: HotkeySettings;\n  audio: AudioSettings;\n  backend: BackendSettings;\n  overlay: OverlaySettings;\n  startMinimized: boolean;\n  showNotifications: boolean;\n};\n\nconst DEFAULT_SETTINGS: AppSettings = {\n  hotkey: {\n    modifiers: [0xa2, 0xa4],\n    debounceMs: 40,\n  },\n  audio: {\n    deviceIndex: null,\n    deviceName: null,\n    sampleRateHz: 16000,\n    channels: 1,\n    frameMs: 20,\n  },\n  backend: {\n    host: \"127.0.0.1\",\n    port: 50051,\n    timeoutSeconds: 30,\n    autoReconnect: true,\n  },\n  overlay: {\n    enabled: true,\n    position: \"top-right\",\n    xOffset: 20,\n    yOffset: 20,\n    autoHideMs: 2000,\n  },\n  startMinimized: true,\n  showNotifications: true,\n};\n\nconst SETTINGS_FILE = \"settings.json\";\n\nconst getSettingsPath = () => path.join(app.getPath(\"userData\"), SETTINGS_FILE);\n\nexport const loadSettings = (): AppSettings => {\n  const filePath = getSettingsPath();\n  try {\n    if (!fs.existsSync(filePath)) {\n      return { ...DEFAULT_SETTINGS };\n    }\n    const raw = fs.readFileSync(filePath, \"utf-8\");\n    const parsed = JSON.parse(raw) as Partial<AppSettings>;\n    return {\n      ...DEFAULT_SETTINGS,\n      ...parsed,\n      hotkey: { ...DEFAULT_SETTINGS.hotkey, ...parsed.hotkey },\n      audio: { ...DEFAULT_SETTINGS.audio, ...parsed.audio },\n      backend: { ...DEFAULT_SETTINGS.backend, ...parsed.backend },\n      overlay: { ...DEFAULT_SETTINGS.overlay, ...parsed.overlay },\n    };\n  } catch (error) {\n    console.warn(\"Failed to load settings, using defaults\", error);\n    return { ...DEFAULT_SETTINGS };\n  }\n};\n\nexport const saveSettings = (settings: AppSettings): void => {\n  const filePath = getSettingsPath();\n  const payload = JSON.stringify(settings, null, 2);\n  fs.mkdirSync(path.dirname(filePath), { recursive: true });\n  fs.writeFileSync(filePath, payload, \"utf-8\");\n};\n\nexport const resetSettings = (): AppSettings => {\n  const settings = { ...DEFAULT_SETTINGS };\n  saveSettings(settings);\n  return settings;\n};\n\nexport const getDefaultSettings = (): AppSettings => ({ ...DEFAULT_SETTINGS });\n","import path from \"node:path\";\nimport { execFileSync, spawnSync } from \"node:child_process\";\nimport fs from \"node:fs\";\n\nexport type PythonInfo = {\n  executable: string;\n  version: string;\n  hasTorch: boolean;\n  hasNemo: boolean;\n  hasCuda: boolean;\n};\n\nexport class PythonNotFoundError extends Error {}\n\nexport class BackendDepsError extends Error {\n  public readonly pythonPath: string;\n\n  constructor(message: string, pythonPath: string) {\n    super(message);\n    this.pythonPath = pythonPath;\n  }\n}\n\nconst runPythonCheck = (pythonPath: string, code: string): string | null => {\n  try {\n    const result = spawnSync(pythonPath, [\"-c\", code], {\n      encoding: \"utf-8\",\n      timeout: 30000,\n      windowsHide: true,\n    });\n    if (result.status === 0) {\n      return result.stdout.trim();\n    }\n    return null;\n  } catch {\n    return null;\n  }\n};\n\nconst checkPythonVersion = (pythonPath: string): string | null =>\n  runPythonCheck(pythonPath, \"import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')\");\n\nconst checkTorch = (pythonPath: string): boolean =>\n  runPythonCheck(pythonPath, \"import torch; print('ok')\") === \"ok\";\n\nconst checkNemo = (pythonPath: string): boolean =>\n  runPythonCheck(pythonPath, \"import nemo; print('ok')\") === \"ok\";\n\nconst checkCuda = (pythonPath: string): boolean =>\n  runPythonCheck(pythonPath, \"import torch; print('ok' if torch.cuda.is_available() else 'no')\") === \"ok\";\n\nconst isValidPython = (version: string | null): boolean => {\n  if (!version) {\n    return false;\n  }\n  const [major, minor] = version.split(\".\").map((part) => Number(part));\n  if (!Number.isFinite(major) || !Number.isFinite(minor)) {\n    return false;\n  }\n  return major > 3 || (major === 3 && minor >= 11);\n};\n\nconst getPythonInfo = (pythonPath: string, checkDeps: boolean): PythonInfo | null => {\n  if (!fs.existsSync(pythonPath)) {\n    return null;\n  }\n  const version = checkPythonVersion(pythonPath);\n  if (!isValidPython(version)) {\n    return null;\n  }\n  const info: PythonInfo = {\n    executable: pythonPath,\n    version: version ?? \"\",\n    hasTorch: false,\n    hasNemo: false,\n    hasCuda: false,\n  };\n\n  if (checkDeps) {\n    info.hasTorch = checkTorch(pythonPath);\n    info.hasNemo = checkNemo(pythonPath);\n    if (info.hasTorch) {\n      info.hasCuda = checkCuda(pythonPath);\n    }\n  }\n\n  return info;\n};\n\nconst findEnvPython = (): string | null => {\n  const envPython = process.env.KEYMUSE_PYTHON;\n  if (envPython && fs.existsSync(envPython)) {\n    return envPython;\n  }\n  return null;\n};\n\nconst findVenvPython = (appRoot: string): string | null => {\n  const searchPaths = [\n    path.join(appRoot, \".venv\", \"Scripts\", \"python.exe\"),\n    path.join(appRoot, \"..\", \".venv\", \"Scripts\", \"python.exe\"),\n    path.join(appRoot, \"..\", \"..\", \".venv\", \"Scripts\", \"python.exe\"),\n  ];\n  for (const candidate of searchPaths) {\n    if (fs.existsSync(candidate)) {\n      return candidate;\n    }\n  }\n  return null;\n};\n\nconst findPathPython = (): string | null => {\n  const command = process.platform === \"win32\" ? \"where\" : \"which\";\n  try {\n    const output = execFileSync(command, [\"python\"], { encoding: \"utf-8\" }).trim();\n    const first = output.split(/\\r?\\n/)[0];\n    if (first && fs.existsSync(first)) {\n      return first;\n    }\n  } catch {\n    return null;\n  }\n  return null;\n};\n\nconst findPyLauncher = (): string | null => {\n  if (process.platform !== \"win32\") {\n    return null;\n  }\n  for (const version of [\"3.12\", \"3.11\"]) {\n    try {\n      const output = execFileSync(\"py\", [`-${version}`, \"-c\", \"import sys; print(sys.executable)\"] , {\n        encoding: \"utf-8\",\n        windowsHide: true,\n      }).trim();\n      if (output && fs.existsSync(output)) {\n        return output;\n      }\n    } catch {\n      continue;\n    }\n  }\n  return null;\n};\n\nconst findCommonInstall = (): string | null => {\n  if (process.platform !== \"win32\") {\n    return null;\n  }\n  const localAppData = process.env.LOCALAPPDATA ?? \"\";\n  const candidates = [\n    localAppData && path.join(localAppData, \"Programs\", \"Python\"),\n    \"C:/Python312\",\n    \"C:/Python311\",\n    \"C:/Program Files/Python312\",\n    \"C:/Program Files/Python311\",\n  ].filter(Boolean) as string[];\n\n  for (const base of candidates) {\n    if (!fs.existsSync(base)) {\n      continue;\n    }\n    const direct = path.join(base, \"python.exe\");\n    if (fs.existsSync(direct)) {\n      return direct;\n    }\n    try {\n      const subdirs = fs.readdirSync(base, { withFileTypes: true });\n      for (const sub of subdirs) {\n        if (sub.isDirectory() && sub.name.startsWith(\"Python\")) {\n          const candidate = path.join(base, sub.name, \"python.exe\");\n          if (fs.existsSync(candidate)) {\n            return candidate;\n          }\n        }\n      }\n    } catch {\n      continue;\n    }\n  }\n  return null;\n};\n\nexport const findPython = (appRoot: string, checkDeps = true): PythonInfo => {\n  const finders = [\n    findEnvPython,\n    () => findVenvPython(appRoot),\n    findPathPython,\n    findPyLauncher,\n    findCommonInstall,\n  ];\n\n  let found: PythonInfo | null = null;\n\n  for (const finder of finders) {\n    const candidate = finder();\n    if (!candidate) {\n      continue;\n    }\n    const info = getPythonInfo(candidate, checkDeps);\n    if (!info) {\n      continue;\n    }\n    if (!checkDeps || (info.hasTorch && info.hasNemo)) {\n      return info;\n    }\n    if (!found) {\n      found = info;\n    }\n  }\n\n  if (found) {\n    const missing = [!found.hasTorch && \"torch\", !found.hasNemo && \"nemo\"].filter(Boolean).join(\", \");\n    throw new BackendDepsError(\n      `Python found but missing backend dependencies: ${missing}.`,\n      found.executable,\n    );\n  }\n\n  throw new PythonNotFoundError(\n    \"Python 3.11+ not found. Install Python or set KEYMUSE_PYTHON to your Python executable.\",\n  );\n};\n\nexport const installBackendDeps = (pythonPath: string, repoRoot: string): void => {\n  const requirements = path.join(repoRoot, \"backend\", \"requirements.txt\");\n  execFileSync(pythonPath, [\"-m\", \"pip\", \"install\", \"-r\", requirements], {\n    stdio: \"inherit\",\n  });\n};\n","import { spawn } from \"node:child_process\";\nimport path from \"node:path\";\nimport { BackendDepsError } from \"./python-finder\";\nimport type { PythonInfo } from \"./python-finder\";\nimport { REPO_ROOT } from \"./constants\";\n\nexport type BackendStartOptions = {\n  host: string;\n  port: number;\n  mode?: string;\n  device?: string;\n  model?: string;\n  onOutput?: (line: string) => void;\n};\n\nexport type BackendProcess = {\n  process: ReturnType<typeof spawn>;\n  kill: () => void;\n};\n\nconst buildPythonPath = (repoRoot: string): string => {\n  const paths = [\n    path.join(repoRoot, \"shared\", \"src\"),\n    path.join(repoRoot, \"backend\", \"src\"),\n    path.join(repoRoot, \"client\", \"src\"),\n  ];\n  const existing = process.env.PYTHONPATH;\n  if (existing) {\n    paths.push(existing);\n  }\n  return paths.join(path.delimiter);\n};\n\nexport const startBackend = (\n  python: PythonInfo,\n  options: BackendStartOptions,\n): BackendProcess => {\n  const env: Record<string, string> = {\n    ...process.env,\n    PYTHONPATH: buildPythonPath(REPO_ROOT),\n    KEYMUSE_HOST: options.host,\n    KEYMUSE_PORT: String(options.port),\n    PYTHONUNBUFFERED: \"1\",\n  };\n\n  if (options.mode) {\n    env.KEYMUSE_MODE = options.mode;\n  }\n  if (options.device) {\n    env.KEYMUSE_DEVICE = options.device;\n  }\n  if (options.model) {\n    env.KEYMUSE_MODEL = options.model;\n  }\n\n  const cmd = [\"-m\", \"keymuse_backend.server\"];\n  const child = spawn(python.executable, cmd, {\n    env,\n    windowsHide: true,\n  });\n\n  const handleOutput = (data: Buffer) => {\n    const text = data.toString();\n    for (const line of text.split(/\\r?\\n/)) {\n      if (!line.trim()) {\n        continue;\n      }\n      options.onOutput?.(line.trim());\n    }\n  };\n\n  child.stdout?.on(\"data\", handleOutput);\n  child.stderr?.on(\"data\", handleOutput);\n\n  return {\n    process: child,\n    kill: () => {\n      if (!child.killed) {\n        child.kill();\n      }\n    },\n  };\n};\n\nexport const ensureBackendDeps = (python: PythonInfo): void => {\n  if (!python.hasTorch || !python.hasNemo) {\n    const missing = [!python.hasTorch && \"torch\", !python.hasNemo && \"nemo\"]\n      .filter(Boolean)\n      .join(\", \");\n    throw new BackendDepsError(\n      `Python found but missing backend dependencies: ${missing}.`,\n      python.executable,\n    );\n  }\n};\n"],"mappings":";;;;;;;AAAA,IAAAA,mBAAqF;AACrF,OAAOC,WAAU;;;ACDjB,SAAS,6BAA6B;AACtC,SAAS,gBAAgB;;;ACDzB,OAAO,UAAU;AAEV,IAAM,SAAS,QAAQ,IAAI,aAAa;AAExC,IAAM,WAAW,KAAK,QAAQ,WAAW,IAAI;AAE7C,IAAM,YAAY,KAAK,QAAQ,UAAU,MAAM,IAAI;AAEnD,IAAM,eAAe,KAAK,KAAK,UAAU,UAAU;AACnD,IAAM,oBAAoB;AAE1B,IAAM,gBAAgB,KAAK,KAAK,UAAU,eAAe;AACzD,IAAM,gBAAgB,KAAK,KAAK,UAAU,MAAM;AAChD,IAAM,mBAAmB;AACzB,IAAM,aAAa,KAAK,KAAK,WAAW,UAAU,SAAS,iBAAiB;;;ADsB5E,IAAM,wBAAwB,CAAC,MAAc,SAAkC;AACpF,QAAM,YAAY;AAClB,QAAM,oBAAoB,SAAS,WAAW;AAAA,IAC5C,UAAU;AAAA,IACV,OAAO;AAAA,IACP,OAAO;AAAA,IACP,UAAU;AAAA,IACV,QAAQ;AAAA,EACV,CAAC;AAED,QAAM,cAAc,sBAAsB,iBAAiB;AAG3D,QAAM,UAAU,YAAY,QAAQ,UAAU,GAAG;AACjD,QAAM,SAAS,IAAI,QAAQ,GAAG,IAAI,IAAI,IAAI,IAAI,0BAA0B,CAAC;AAEzE,SAAO;AAAA,IACL,WAAW,CAAC,YACV,IAAI,QAAQ,CAAC,SAAS,WAAW;AAC/B,aAAO,UAAU,SAAS,CAAC,OAAO,aAAa;AAC7C,YAAI,OAAO;AACT,iBAAO,KAAK;AACZ;AAAA,QACF;AACA,gBAAQ,QAAQ;AAAA,MAClB,CAAC;AAAA,IACH,CAAC;AAAA,IACH,aAAa,MAAM,OAAO,YAAY;AAAA,EACxC;AACF;AAEA,IAAM,4BAA4B,MAAe;AAE/C,QAAM,OAAO,UAAQ,eAAe;AACpC,SAAO,KAAK,YAAY,eAAe;AACzC;AAEO,IAAM,cAAc,CACzB,QACA,SACA,YACqC;AACrC,QAAM,SAAS,OAAO,YAAY;AAClC,SAAO,GAAG,QAAQ,CAAC,UAA0B,QAAQ,KAAK,CAAC;AAC3D,SAAO,GAAG,SAAS,CAAC,UAAiB,QAAQ,KAAK,CAAC;AACnD,SAAO;AACT;;;AEnEO,IAAM,oBAAoB,OAC/B,YACmC;AACnC,QAAM,kBAAkB,MAAM,OAAO,WAAW;AAChD,QAAM,YAAY;AAUlB,QAAM,eAAe,KAAK,MAAO,QAAQ,eAAe,QAAQ,UAAW,GAAI;AAC/E,QAAM,aAAa,eAAe,QAAQ,WAAW;AAErD,QAAM,QAAQ,IAAI,UAAU,WAAW;AAAA,IACrC,cAAc,QAAQ;AAAA,IACtB,cAAc,UAAU;AAAA,IACxB,YAAY,QAAQ;AAAA,IACpB,UAAU,QAAQ,eAAe;AAAA,IACjC,cAAc;AAAA,EAChB,CAAC;AAED,MAAI,WAAW,OAAO,CAAC;AACvB,MAAI,UAAgD;AACpD,MAAI,SAAS,OAAO,MAAM,CAAC;AAE3B,QAAM,GAAG,QAAQ,CAAC,UAAkB;AAClC,aAAS,OAAO,OAAO,CAAC,QAAQ,KAAK,CAAC;AACtC,WAAO,OAAO,UAAU,YAAY;AAClC,YAAM,QAAQ,OAAO,SAAS,GAAG,UAAU;AAC3C,eAAS,OAAO,SAAS,UAAU;AACnC,UAAI,SAAS;AACX,gBAAQ;AAAA,UACN,OAAO;AAAA,UACP,gBAAgB,QAAQ;AAAA,UACxB,UAAU,QAAQ;AAAA,UAClB,UAAU;AAAA,UACV,eAAe;AAAA,QACjB,CAAC;AAAA,MACH;AAAA,IACF;AAAA,EACF,CAAC;AAED,SAAO;AAAA,IACL,OAAO,MAAM,MAAM,MAAM;AAAA,IACzB,MAAM,MAAM,MAAM,KAAK;AAAA,IACvB,SAAS,CAAC,aAAa;AACrB,gBAAU;AAAA,IACZ;AAAA,EACF;AACF;;;ACpEA,SAAS,eAAe;AAOxB,IAAM,YAAY,oBAAI,IAAI,CAAC,IAAI,IAAI,CAAC;AACpC,IAAM,WAAW,oBAAI,IAAI,CAAC,IAAI,IAAI,CAAC;AAE5B,IAAM,qBAAqB,CAAC,EAAE,YAAY,aAAa,MAA6B;AACzF,MAAI,WAAW;AACf,MAAI,UAAU;AACd,MAAI,SAAS;AAEb,QAAM,cAAc,MAAM;AACxB,UAAM,iBAAiB,YAAY;AACnC,QAAI,kBAAkB,CAAC,QAAQ;AAC7B,eAAS;AACT,iBAAW;AAAA,IACb,WAAW,CAAC,kBAAkB,QAAQ;AACpC,eAAS;AACT,mBAAa;AAAA,IACf;AAAA,EACF;AAEA,UAAQ,GAAG,WAAW,CAAC,UAAU;AAC/B,QAAI,UAAU,IAAI,MAAM,OAAO,GAAG;AAChC,iBAAW;AAAA,IACb;AACA,QAAI,SAAS,IAAI,MAAM,OAAO,GAAG;AAC/B,gBAAU;AAAA,IACZ;AACA,gBAAY;AAAA,EACd,CAAC;AAED,UAAQ,GAAG,SAAS,CAAC,UAAU;AAC7B,QAAI,UAAU,IAAI,MAAM,OAAO,GAAG;AAChC,iBAAW;AAAA,IACb;AACA,QAAI,SAAS,IAAI,MAAM,OAAO,GAAG;AAC/B,gBAAU;AAAA,IACZ;AACA,gBAAY;AAAA,EACd,CAAC;AAED,UAAQ,MAAM;AAChB;AAEO,IAAM,qBAAqB,MAAY;AAC5C,UAAQ,mBAAmB;AAC3B,UAAQ,KAAK;AACf;;;ACpDA,IAAM,cAAc;AACpB,IAAI,UAAoB,CAAC;AAElB,IAAM,gBAAgB,CAAC,SAAuB;AACnD,YAAU,CAAC,GAAG,SAAS,IAAI,EAAE,MAAM,CAAC,WAAW;AACjD;AAEO,IAAM,aAAa,MAAgB,CAAC,GAAG,OAAO;AAE9C,IAAM,oBAAoB,MAAqB;AACpD,MAAI,QAAQ,WAAW,GAAG;AACxB,WAAO;AAAA,EACT;AACA,SAAO,QAAQ,QAAQ,SAAS,CAAC;AACnC;;;ACdA,sBAA0B;AAG1B,IAAM,kBAAkB;AACxB,IAAM,eAAe,IAAI,OAAO,kDAAkD,GAAG;AAE9E,IAAM,eAAe,CAAC,SAAyB;AACpD,MAAI,YAAY,KAAK,QAAQ,iBAAiB,EAAE,EAAE,QAAQ,cAAc,EAAE;AAC1E,cAAY,UAAU,UAAU,KAAK;AACrC,cAAY,UAAU,QAAQ,SAAS,IAAI,EAAE,QAAQ,OAAO,IAAI,EAAE,QAAQ,OAAO,MAAM;AACvF,SAAO;AACT;AAEO,IAAM,mBAAmB,CAAC,SAAuB;AACtD,4BAAU,UAAU,IAAI;AAC1B;AAIO,IAAM,YAAY,MAAY;AAErC;;;ACrBA,IAAAC,mBAAoB;AACpB,OAAO,QAAQ;AACf,OAAOC,WAAU;AAuCjB,IAAM,mBAAgC;AAAA,EACpC,QAAQ;AAAA,IACN,WAAW,CAAC,KAAM,GAAI;AAAA,IACtB,YAAY;AAAA,EACd;AAAA,EACA,OAAO;AAAA,IACL,aAAa;AAAA,IACb,YAAY;AAAA,IACZ,cAAc;AAAA,IACd,UAAU;AAAA,IACV,SAAS;AAAA,EACX;AAAA,EACA,SAAS;AAAA,IACP,MAAM;AAAA,IACN,MAAM;AAAA,IACN,gBAAgB;AAAA,IAChB,eAAe;AAAA,EACjB;AAAA,EACA,SAAS;AAAA,IACP,SAAS;AAAA,IACT,UAAU;AAAA,IACV,SAAS;AAAA,IACT,SAAS;AAAA,IACT,YAAY;AAAA,EACd;AAAA,EACA,gBAAgB;AAAA,EAChB,mBAAmB;AACrB;AAEA,IAAM,gBAAgB;AAEtB,IAAM,kBAAkB,MAAMA,MAAK,KAAK,qBAAI,QAAQ,UAAU,GAAG,aAAa;AAEvE,IAAM,eAAe,MAAmB;AAC7C,QAAM,WAAW,gBAAgB;AACjC,MAAI;AACF,QAAI,CAAC,GAAG,WAAW,QAAQ,GAAG;AAC5B,aAAO,EAAE,GAAG,iBAAiB;AAAA,IAC/B;AACA,UAAM,MAAM,GAAG,aAAa,UAAU,OAAO;AAC7C,UAAM,SAAS,KAAK,MAAM,GAAG;AAC7B,WAAO;AAAA,MACL,GAAG;AAAA,MACH,GAAG;AAAA,MACH,QAAQ,EAAE,GAAG,iBAAiB,QAAQ,GAAG,OAAO,OAAO;AAAA,MACvD,OAAO,EAAE,GAAG,iBAAiB,OAAO,GAAG,OAAO,MAAM;AAAA,MACpD,SAAS,EAAE,GAAG,iBAAiB,SAAS,GAAG,OAAO,QAAQ;AAAA,MAC1D,SAAS,EAAE,GAAG,iBAAiB,SAAS,GAAG,OAAO,QAAQ;AAAA,IAC5D;AAAA,EACF,SAAS,OAAO;AACd,YAAQ,KAAK,2CAA2C,KAAK;AAC7D,WAAO,EAAE,GAAG,iBAAiB;AAAA,EAC/B;AACF;AAEO,IAAM,eAAe,CAACC,cAAgC;AAC3D,QAAM,WAAW,gBAAgB;AACjC,QAAM,UAAU,KAAK,UAAUA,WAAU,MAAM,CAAC;AAChD,KAAG,UAAUD,MAAK,QAAQ,QAAQ,GAAG,EAAE,WAAW,KAAK,CAAC;AACxD,KAAG,cAAc,UAAU,SAAS,OAAO;AAC7C;;;ACrGA,OAAOE,WAAU;AACjB,SAAS,cAAc,iBAAiB;AACxC,OAAOC,SAAQ;AAUR,IAAM,sBAAN,cAAkC,MAAM;AAAC;AAEzC,IAAM,mBAAN,cAA+B,MAAM;AAAA,EAC1B;AAAA,EAEhB,YAAY,SAAiB,YAAoB;AAC/C,UAAM,OAAO;AACb,SAAK,aAAa;AAAA,EACpB;AACF;AAEA,IAAM,iBAAiB,CAAC,YAAoB,SAAgC;AAC1E,MAAI;AACF,UAAM,SAAS,UAAU,YAAY,CAAC,MAAM,IAAI,GAAG;AAAA,MACjD,UAAU;AAAA,MACV,SAAS;AAAA,MACT,aAAa;AAAA,IACf,CAAC;AACD,QAAI,OAAO,WAAW,GAAG;AACvB,aAAO,OAAO,OAAO,KAAK;AAAA,IAC5B;AACA,WAAO;AAAA,EACT,QAAQ;AACN,WAAO;AAAA,EACT;AACF;AAEA,IAAM,qBAAqB,CAAC,eAC1B,eAAe,YAAY,yEAAyE;AAEtG,IAAM,aAAa,CAAC,eAClB,eAAe,YAAY,2BAA2B,MAAM;AAE9D,IAAM,YAAY,CAAC,eACjB,eAAe,YAAY,0BAA0B,MAAM;AAE7D,IAAM,YAAY,CAAC,eACjB,eAAe,YAAY,kEAAkE,MAAM;AAErG,IAAM,gBAAgB,CAAC,YAAoC;AACzD,MAAI,CAAC,SAAS;AACZ,WAAO;AAAA,EACT;AACA,QAAM,CAAC,OAAO,KAAK,IAAI,QAAQ,MAAM,GAAG,EAAE,IAAI,CAAC,SAAS,OAAO,IAAI,CAAC;AACpE,MAAI,CAAC,OAAO,SAAS,KAAK,KAAK,CAAC,OAAO,SAAS,KAAK,GAAG;AACtD,WAAO;AAAA,EACT;AACA,SAAO,QAAQ,KAAM,UAAU,KAAK,SAAS;AAC/C;AAEA,IAAM,gBAAgB,CAAC,YAAoB,cAA0C;AACnF,MAAI,CAACA,IAAG,WAAW,UAAU,GAAG;AAC9B,WAAO;AAAA,EACT;AACA,QAAM,UAAU,mBAAmB,UAAU;AAC7C,MAAI,CAAC,cAAc,OAAO,GAAG;AAC3B,WAAO;AAAA,EACT;AACA,QAAM,OAAmB;AAAA,IACvB,YAAY;AAAA,IACZ,SAAS,WAAW;AAAA,IACpB,UAAU;AAAA,IACV,SAAS;AAAA,IACT,SAAS;AAAA,EACX;AAEA,MAAI,WAAW;AACb,SAAK,WAAW,WAAW,UAAU;AACrC,SAAK,UAAU,UAAU,UAAU;AACnC,QAAI,KAAK,UAAU;AACjB,WAAK,UAAU,UAAU,UAAU;AAAA,IACrC;AAAA,EACF;AAEA,SAAO;AACT;AAEA,IAAM,gBAAgB,MAAqB;AACzC,QAAM,YAAY,QAAQ,IAAI;AAC9B,MAAI,aAAaA,IAAG,WAAW,SAAS,GAAG;AACzC,WAAO;AAAA,EACT;AACA,SAAO;AACT;AAEA,IAAM,iBAAiB,CAAC,YAAmC;AACzD,QAAM,cAAc;AAAA,IAClBD,MAAK,KAAK,SAAS,SAAS,WAAW,YAAY;AAAA,IACnDA,MAAK,KAAK,SAAS,MAAM,SAAS,WAAW,YAAY;AAAA,IACzDA,MAAK,KAAK,SAAS,MAAM,MAAM,SAAS,WAAW,YAAY;AAAA,EACjE;AACA,aAAW,aAAa,aAAa;AACnC,QAAIC,IAAG,WAAW,SAAS,GAAG;AAC5B,aAAO;AAAA,IACT;AAAA,EACF;AACA,SAAO;AACT;AAEA,IAAM,iBAAiB,MAAqB;AAC1C,QAAM,UAAU,QAAQ,aAAa,UAAU,UAAU;AACzD,MAAI;AACF,UAAM,SAAS,aAAa,SAAS,CAAC,QAAQ,GAAG,EAAE,UAAU,QAAQ,CAAC,EAAE,KAAK;AAC7E,UAAM,QAAQ,OAAO,MAAM,OAAO,EAAE,CAAC;AACrC,QAAI,SAASA,IAAG,WAAW,KAAK,GAAG;AACjC,aAAO;AAAA,IACT;AAAA,EACF,QAAQ;AACN,WAAO;AAAA,EACT;AACA,SAAO;AACT;AAEA,IAAM,iBAAiB,MAAqB;AAC1C,MAAI,QAAQ,aAAa,SAAS;AAChC,WAAO;AAAA,EACT;AACA,aAAW,WAAW,CAAC,QAAQ,MAAM,GAAG;AACtC,QAAI;AACF,YAAM,SAAS,aAAa,MAAM,CAAC,IAAI,OAAO,IAAI,MAAM,mCAAmC,GAAI;AAAA,QAC7F,UAAU;AAAA,QACV,aAAa;AAAA,MACf,CAAC,EAAE,KAAK;AACR,UAAI,UAAUA,IAAG,WAAW,MAAM,GAAG;AACnC,eAAO;AAAA,MACT;AAAA,IACF,QAAQ;AACN;AAAA,IACF;AAAA,EACF;AACA,SAAO;AACT;AAEA,IAAM,oBAAoB,MAAqB;AAC7C,MAAI,QAAQ,aAAa,SAAS;AAChC,WAAO;AAAA,EACT;AACA,QAAM,eAAe,QAAQ,IAAI,gBAAgB;AACjD,QAAM,aAAa;AAAA,IACjB,gBAAgBD,MAAK,KAAK,cAAc,YAAY,QAAQ;AAAA,IAC5D;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACF,EAAE,OAAO,OAAO;AAEhB,aAAW,QAAQ,YAAY;AAC7B,QAAI,CAACC,IAAG,WAAW,IAAI,GAAG;AACxB;AAAA,IACF;AACA,UAAM,SAASD,MAAK,KAAK,MAAM,YAAY;AAC3C,QAAIC,IAAG,WAAW,MAAM,GAAG;AACzB,aAAO;AAAA,IACT;AACA,QAAI;AACF,YAAM,UAAUA,IAAG,YAAY,MAAM,EAAE,eAAe,KAAK,CAAC;AAC5D,iBAAW,OAAO,SAAS;AACzB,YAAI,IAAI,YAAY,KAAK,IAAI,KAAK,WAAW,QAAQ,GAAG;AACtD,gBAAM,YAAYD,MAAK,KAAK,MAAM,IAAI,MAAM,YAAY;AACxD,cAAIC,IAAG,WAAW,SAAS,GAAG;AAC5B,mBAAO;AAAA,UACT;AAAA,QACF;AAAA,MACF;AAAA,IACF,QAAQ;AACN;AAAA,IACF;AAAA,EACF;AACA,SAAO;AACT;AAEO,IAAM,aAAa,CAAC,SAAiB,YAAY,SAAqB;AAC3E,QAAM,UAAU;AAAA,IACd;AAAA,IACA,MAAM,eAAe,OAAO;AAAA,IAC5B;AAAA,IACA;AAAA,IACA;AAAA,EACF;AAEA,MAAI,QAA2B;AAE/B,aAAW,UAAU,SAAS;AAC5B,UAAM,YAAY,OAAO;AACzB,QAAI,CAAC,WAAW;AACd;AAAA,IACF;AACA,UAAM,OAAO,cAAc,WAAW,SAAS;AAC/C,QAAI,CAAC,MAAM;AACT;AAAA,IACF;AACA,QAAI,CAAC,aAAc,KAAK,YAAY,KAAK,SAAU;AACjD,aAAO;AAAA,IACT;AACA,QAAI,CAAC,OAAO;AACV,cAAQ;AAAA,IACV;AAAA,EACF;AAEA,MAAI,OAAO;AACT,UAAM,UAAU,CAAC,CAAC,MAAM,YAAY,SAAS,CAAC,MAAM,WAAW,MAAM,EAAE,OAAO,OAAO,EAAE,KAAK,IAAI;AAChG,UAAM,IAAI;AAAA,MACR,kDAAkD,OAAO;AAAA,MACzD,MAAM;AAAA,IACR;AAAA,EACF;AAEA,QAAM,IAAI;AAAA,IACR;AAAA,EACF;AACF;AAEO,IAAM,qBAAqB,CAAC,YAAoB,aAA2B;AAChF,QAAM,eAAeD,MAAK,KAAK,UAAU,WAAW,kBAAkB;AACtE,eAAa,YAAY,CAAC,MAAM,OAAO,WAAW,MAAM,YAAY,GAAG;AAAA,IACrE,OAAO;AAAA,EACT,CAAC;AACH;;;ACrOA,SAAS,aAAa;AACtB,OAAOE,WAAU;AAmBjB,IAAM,kBAAkB,CAAC,aAA6B;AACpD,QAAM,QAAQ;AAAA,IACZC,MAAK,KAAK,UAAU,UAAU,KAAK;AAAA,IACnCA,MAAK,KAAK,UAAU,WAAW,KAAK;AAAA,IACpCA,MAAK,KAAK,UAAU,UAAU,KAAK;AAAA,EACrC;AACA,QAAM,WAAW,QAAQ,IAAI;AAC7B,MAAI,UAAU;AACZ,UAAM,KAAK,QAAQ;AAAA,EACrB;AACA,SAAO,MAAM,KAAKA,MAAK,SAAS;AAClC;AAEO,IAAM,eAAe,CAC1B,QACA,YACmB;AApCrB;AAqCE,QAAM,MAA8B;AAAA,IAClC,GAAG,QAAQ;AAAA,IACX,YAAY,gBAAgB,SAAS;AAAA,IACrC,cAAc,QAAQ;AAAA,IACtB,cAAc,OAAO,QAAQ,IAAI;AAAA,IACjC,kBAAkB;AAAA,EACpB;AAEA,MAAI,QAAQ,MAAM;AAChB,QAAI,eAAe,QAAQ;AAAA,EAC7B;AACA,MAAI,QAAQ,QAAQ;AAClB,QAAI,iBAAiB,QAAQ;AAAA,EAC/B;AACA,MAAI,QAAQ,OAAO;AACjB,QAAI,gBAAgB,QAAQ;AAAA,EAC9B;AAEA,QAAM,MAAM,CAAC,MAAM,wBAAwB;AAC3C,QAAM,QAAQ,MAAM,OAAO,YAAY,KAAK;AAAA,IAC1C;AAAA,IACA,aAAa;AAAA,EACf,CAAC;AAED,QAAM,eAAe,CAAC,SAAiB;AA7DzC,QAAAC;AA8DI,UAAM,OAAO,KAAK,SAAS;AAC3B,eAAW,QAAQ,KAAK,MAAM,OAAO,GAAG;AACtC,UAAI,CAAC,KAAK,KAAK,GAAG;AAChB;AAAA,MACF;AACA,OAAAA,MAAA,QAAQ,aAAR,gBAAAA,IAAA,cAAmB,KAAK,KAAK;AAAA,IAC/B;AAAA,EACF;AAEA,cAAM,WAAN,mBAAc,GAAG,QAAQ;AACzB,cAAM,WAAN,mBAAc,GAAG,QAAQ;AAEzB,SAAO;AAAA,IACL,SAAS;AAAA,IACT,MAAM,MAAM;AACV,UAAI,CAAC,MAAM,QAAQ;AACjB,cAAM,KAAK;AAAA,MACb;AAAA,IACF;AAAA,EACF;AACF;;;AT9DA,IAAI,aAAmC;AACvC,IAAI,gBAAsC;AAC1C,IAAI,OAAoB;AACxB,IAAI,WAAW,aAAa;AAC5B,IAAI,iBAA8C;AAClD,IAAI,kBAAwE;AAC5E,IAAI,kBAAyD;AAC7D,IAAI,kBAAkB;AAEtB,IAAM,mBAAmB,MAAM;AAC7B,eAAa,IAAI,+BAAc;AAAA,IAC7B,OAAO;AAAA,IACP,QAAQ;AAAA,IACR,UAAU;AAAA,IACV,WAAW;AAAA,IACX,MAAM,CAAC,SAAS;AAAA,IAChB,iBAAiB;AAAA,IACjB,gBAAgB;AAAA,MACd,SAASC,MAAK,KAAK,UAAU,iBAAiB,aAAa;AAAA,MAC3D,kBAAkB;AAAA,MAClB,iBAAiB;AAAA,IACnB;AAAA,EACF,CAAC;AAED,MAAI,QAAQ;AACV,eAAW,QAAQ,gBAAgB;AACnC,eAAW,YAAY,aAAa,EAAE,MAAM,SAAS,CAAC;AAAA,EACxD,OAAO;AACL,eAAW,SAASA,MAAK,KAAK,eAAe,YAAY,CAAC;AAAA,EAC5D;AAEA,aAAW,GAAG,SAAS,CAAC,UAAU;AAChC,QAAI,MAAM;AACR,YAAM,eAAe;AACrB,+CAAY;AAAA,IACd;AAAA,EACF,CAAC;AACH;AAEA,IAAM,sBAAsB,MAAM;AAChC,kBAAgB,IAAI,+BAAc;AAAA,IAChC,OAAO;AAAA,IACP,QAAQ;AAAA,IACR,aAAa;AAAA,IACb,OAAO;AAAA,IACP,aAAa;AAAA,IACb,MAAM;AAAA,IACN,WAAW;AAAA,IACX,aAAa;AAAA,IACb,gBAAgB;AAAA,MACd,SAASA,MAAK,KAAK,UAAU,iBAAiB,qBAAqB;AAAA,MACnE,kBAAkB;AAAA,MAClB,iBAAiB;AAAA,IACnB;AAAA,EACF,CAAC;AAED,gBAAc,qBAAqB,IAAI;AACvC,gBAAc,SAASA,MAAK,KAAK,cAAc,cAAc,CAAC;AAChE;AAEA,IAAM,kBAAkB,CAAC,SAA6C;AACpE,MAAI,CAAC,eAAe;AAClB;AAAA,EACF;AACA,QAAM,EAAE,SAAS,QAAQ,IAAI,SAAS;AACtC,QAAM,EAAE,OAAO,OAAO,IAAI,cAAc,UAAU;AAClD,QAAM,EAAE,OAAO,SAAS,QAAQ,QAAQ,IAAI,wBAAO,kBAAkB,EAAE;AACvE,MAAI,IAAI;AACR,MAAI,IAAI;AACR,MAAI,KAAK,SAAS,OAAO,GAAG;AAC1B,QAAI,UAAU,QAAQ;AAAA,EACxB;AACA,MAAI,KAAK,SAAS,QAAQ,GAAG;AAC3B,QAAI,UAAU,SAAS;AAAA,EACzB;AACA,gBAAc,YAAY,GAAG,GAAG,KAAK;AACvC;AAEA,IAAM,cAAc,CAAC,MAAc,SAA4D;AAC7F,MAAI,CAAC,SAAS,QAAQ,WAAW,CAAC,eAAe;AAC/C;AAAA,EACF;AACA,kBAAgB,SAAS,QAAQ,QAAQ;AACzC,gBAAc,aAAa;AAC3B,gBAAc,YAAY,KAAK,kBAAkB,EAAE,MAAM,KAAK,CAAC;AAC/D,MAAI,SAAS,eAAe,SAAS,QAAQ,aAAa,GAAG;AAC3D,eAAW,MAAM,+CAAe,QAAQ,SAAS,QAAQ,UAAU;AAAA,EACrE;AACF;AAEA,IAAM,cAAc,MAAM;AACxB,iDAAe;AACjB;AAEA,IAAM,aAAa,MAAM;AACvB,SAAO,IAAI,sBAAK,6BAAY,YAAY,CAAC;AACzC,QAAM,cAAc,sBAAK,kBAAkB;AAAA,IACzC;AAAA,MACE,OAAO;AAAA,MACP,OAAO,MAAM,yCAAY;AAAA,IAC3B;AAAA,IACA;AAAA,MACE,OAAO;AAAA,MACP,OAAO,MAAM;AACX,cAAM,OAAO,kBAAkB;AAC/B,YAAI,MAAM;AACR,2BAAiB,IAAI;AAAA,QACvB;AAAA,MACF;AAAA,IACF;AAAA,IACA,EAAE,MAAM,YAAY;AAAA,IACpB;AAAA,MACE,OAAO;AAAA,MACP,OAAO,MAAM,qBAAI,KAAK;AAAA,IACxB;AAAA,EACF,CAAC;AACD,OAAK,WAAW,qCAAqC;AACrD,OAAK,eAAe,WAAW;AAC/B,OAAK,GAAG,gBAAgB,MAAM,yCAAY,MAAM;AAClD;AAEA,IAAM,gBAAgB,YAAY;AAChC,QAAM,eAAe,CAAC,YAAgC;AACpD,6CAAY,YAAY,KAAK,kBAAkB;AAC/C,6CAAY,YAAY,KAAK,kBAAkB,EAAE,OAAO,OAAO,QAAQ,QAAQ,OAAO;AACtF,6CAAY,YAAY,KAAK,eAAe,QAAQ;AAAA,EACtD;AAEA,MAAI;AACF,UAAM,SAAS,WAAW,UAAU,IAAI;AACxC,WAAO;AAAA,EACT,SAAS,OAAO;AACd,QAAI,iBAAiB,kBAAkB;AACrC,8BAAO,eAAe;AAAA,QACpB,MAAM;AAAA,QACN,OAAO;AAAA,QACP,SACE;AAAA,MACJ,CAAC;AACD,mBAAa,EAAE,QAAQ,6CAA6C,CAAC;AACrE,yBAAmB,MAAM,YAAYA,MAAK,QAAQ,UAAU,MAAM,IAAI,CAAC;AACvE,aAAO,WAAW,UAAU,IAAI;AAAA,IAClC;AACA,QAAI,iBAAiB,qBAAqB;AACxC,8BAAO;AAAA,QACL;AAAA,QACA;AAAA,MACF;AACA,+CAAY,YAAY,KAAK,iBAAiB;AAAA,QAC5C,SAAS;AAAA,MACX;AAAA,IACF;AACA,UAAM;AAAA,EACR;AACF;AAEA,IAAM,sBAAsB,YAAY;AACtC,QAAM,SAAS,MAAM,cAAc;AAEnC,QAAM,UAAU,aAAa,QAAQ;AAAA,IACnC,MAAM,SAAS,QAAQ;AAAA,IACvB,MAAM,SAAS,QAAQ;AAAA,IACvB,UAAU,CAAC,SAAS;AAClB,+CAAY,YAAY,KAAK,eAAe;AAC5C,+CAAY,YAAY,KAAK,kBAAkB;AAAA,QAC7C,OAAO;AAAA,QACP,QAAQ;AAAA,MACV;AAAA,IACF;AAAA,EACF,CAAC;AACD,mBAAiB;AAEjB,QAAM,OAAO,sBAAsB,SAAS,QAAQ,MAAM,SAAS,QAAQ,IAAI;AAC/E,MAAI,QAAQ;AACZ,MAAI,WAAW;AACf,SAAO,CAAC,OAAO;AACb,QAAI;AACF,YAAM,SAAS,MAAM,KAAK,UAAU,CAAC,CAAC;AACtC,+CAAY,YAAY,KAAK,kBAAkB,EAAE,OAAO,OAAO,OAAO,QAAQ,OAAO,OAAO;AAC5F,cAAQ,OAAO;AACf,UAAI,CAAC,OAAO;AACV,cAAM,IAAI,QAAQ,CAAC,YAAY,WAAW,SAAS,GAAG,CAAC;AAAA,MACzD;AAAA,IACF,QAAQ;AACN,kBAAY;AACZ,YAAM,UAAU,aAAa,IAAI,2BAA2B,2BAA2B,QAAQ;AAC/F,+CAAY,YAAY,KAAK,kBAAkB;AAAA,QAC7C,OAAO;AAAA,QACP,QAAQ;AAAA,MACV;AACA,+CAAY,YAAY,KAAK,eAAe;AAC5C,YAAM,IAAI,QAAQ,CAAC,YAAY,WAAW,SAAS,GAAG,CAAC;AAAA,IACzD;AAAA,EACF;AACF;AAEA,IAAM,iBAAiB,YAAY;AACjC,MAAI,iBAAiB;AACnB;AAAA,EACF;AACA,oBAAkB;AAClB,2CAAY,YAAY,KAAK,mBAAmB,EAAE,OAAO,YAAY;AACrE,cAAY,gBAAgB,WAAW;AAEvC,QAAM,OAAO,sBAAsB,SAAS,QAAQ,MAAM,SAAS,QAAQ,IAAI;AAC/E,QAAM,SAAS;AAAA,IACb;AAAA,IACA,CAAC,UAAU;AACT,UAAI,MAAM,SAAS;AACjB,oBAAY,MAAM,QAAQ,QAAQ,gBAAgB,WAAW;AAAA,MAC/D;AACA,UAAI,MAAM,OAAO;AACf,cAAM,YAAY,aAAa,MAAM,MAAM,IAAI;AAC/C,sBAAc,SAAS;AACvB,iDAAY,YAAY,KAAK,mBAAmB,EAAE,MAAM,UAAU;AAClE,yBAAiB,SAAS;AAC1B,kBAAU;AACV,oBAAY,aAAa,UAAU,MAAM,GAAG,EAAE,CAAC,IAAI,UAAU;AAAA,MAC/D;AACA,UAAI,MAAM,OAAO;AACf,iDAAY,YAAY,KAAK,mBAAmB,EAAE,OAAO,QAAQ;AACjE,oBAAY,MAAM,MAAM,SAAS,OAAO;AAAA,MAC1C;AAAA,IACF;AAAA,IACA,CAAC,UAAU;AACT,+CAAY,YAAY,KAAK,mBAAmB,EAAE,OAAO,QAAQ;AACjE,kBAAY,MAAM,SAAS,OAAO;AAAA,IACpC;AAAA,EACF;AACA,oBAAkB;AAElB,oBAAkB,MAAM,kBAAkB;AAAA,IACxC,cAAc,SAAS,MAAM;AAAA,IAC7B,UAAU,SAAS,MAAM;AAAA,IACzB,SAAS,SAAS,MAAM;AAAA,IACxB,aAAa,SAAS,MAAM;AAAA,EAC9B,CAAC;AAED,kBAAgB,QAAQ,CAAC,UAAU;AACjC,uDAAiB,MAAM;AAAA,EACzB,CAAC;AACD,kBAAgB,MAAM;AACxB;AAEA,IAAM,gBAAgB,YAAY;AAChC,MAAI,CAAC,iBAAiB;AACpB;AAAA,EACF;AACA,oBAAkB;AAClB,2CAAY,YAAY,KAAK,mBAAmB,EAAE,OAAO,aAAa;AACtE,cAAY,iBAAiB,YAAY;AACzC,qDAAiB;AACjB,qDAAiB,MAAM;AAAA,IACrB,OAAO,OAAO,MAAM,CAAC;AAAA,IACrB,gBAAgB,SAAS,MAAM;AAAA,IAC/B,UAAU,SAAS,MAAM;AAAA,IACzB,UAAU,OAAO,CAAC;AAAA,IAClB,eAAe;AAAA,EACjB;AACA,qDAAiB;AACjB,oBAAkB;AAClB,QAAM,IAAI,QAAQ,CAAC,YAAY,WAAW,SAAS,GAAG,CAAC;AACvD,cAAY;AACZ,2CAAY,YAAY,KAAK,mBAAmB,EAAE,OAAO,OAAO;AAClE;AAEA,IAAM,UAAU,MAAM;AACpB,2BAAQ,OAAO,gBAAgB,MAAM,QAAQ;AAC7C,2BAAQ,OAAO,iBAAiB,CAAC,QAAQ,SAAsB;AAC7D,eAAW;AACX,iBAAa,QAAQ;AACrB,WAAO;AAAA,EACT,CAAC;AACD,2BAAQ,OAAO,eAAe,MAAM,WAAW,CAAC;AAChD,2BAAQ,OAAO,aAAa,MAAM,iBAAiB;AACnD,2BAAQ,OAAO,mBAAmB,MAAM,eAAe,CAAC;AACxD,2BAAQ,OAAO,kBAAkB,MAAM,cAAc,CAAC;AACtD,2BAAQ,OAAO,eAAe,MAAM,yCAAY,MAAM;AACtD,2BAAQ,OAAO,mBAAmB,MAAM,yCAAY,MAAM;AAC5D;AAEA,IAAM,kBAAkB,MACtB,IAAI,QAAQ,CAAC,YAAY;AACvB,MAAI,CAAC,YAAY;AACf,YAAQ;AACR;AAAA,EACF;AACA,MAAI,WAAW,YAAY,UAAU,GAAG;AACtC,eAAW,YAAY,KAAK,mBAAmB,MAAM,QAAQ,CAAC;AAAA,EAChE,OAAO;AACL,YAAQ;AAAA,EACV;AACF,CAAC;AAEH,IAAM,WAAW,YAAY;AAC3B,mBAAiB;AACjB,sBAAoB;AACpB,aAAW;AACX,UAAQ;AACR,QAAM,gBAAgB;AACtB,2CAAY,YAAY,KAAK,iBAAiB,EAAE,MAAM,kBAAkB;AACxE,2CAAY,YAAY,KAAK,kBAAkB,EAAE,OAAO,OAAO,QAAQ,kBAAkB;AACzF,2CAAY,YAAY,KAAK,eAAe;AAC5C,QAAM,oBAAoB;AAE1B,qBAAmB;AAAA,IACjB,YAAY;AAAA,IACZ,cAAc;AAAA,EAChB,CAAC;AACH;AAEA,qBAAI,UAAU,EAAE,KAAK,QAAQ;AAE7B,qBAAI,GAAG,qBAAqB,MAAM;AAElC,CAAC;AAED,qBAAI,GAAG,eAAe,MAAM;AAC1B,qBAAmB;AACnB,mDAAgB;AAChB,+BAAM;AACR,CAAC;","names":["import_electron","path","import_electron","path","settings","path","fs","path","path","_a","path"]}